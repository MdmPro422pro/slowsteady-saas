// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String       @id @default(uuid())
  email             String       @unique
  password          String?      // Null for OAuth-only users
  name              String?
  walletAddress     String?      @unique // Web3 wallet address
  
  // OAuth fields
  googleId          String?      @unique
  githubId          String?      @unique
  oauthProvider     String?      // "google" | "github"
  
  // 2FA / TOTP
  twoFactorEnabled  Boolean      @default(false)
  twoFactorSecret   String?      // Base32 encoded secret for TOTP
  
  // Metadata
  emailVerified     Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  // Relations
  memberships       Membership[]
  contracts         Contract[]
  messages          Message[]
  
  @@index([email])
  @@index([googleId])
  @@index([githubId])
  @@index([walletAddress])
}

model Membership {
  id                String   @id @default(uuid())
  userId            String?
  walletAddress     String   // Primary identifier for Web3 users
  tier              String   // "basic" | "pro" | "elite"
  level             Int      // 1, 2, 3
  paymentStatus     String   // "paid" | "pending" | "failed" | "cancelled"
  stripeSessionId   String   @unique
  stripeCustomerId  String?
  amount            Int      // Amount in cents
  currency          String   @default("usd")
  expiresAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User?    @relation(fields: [userId], references: [id])
  
  @@index([walletAddress])
  @@index([stripeSessionId])
  @@index([paymentStatus])
}

model Contract {
  id                String   @id @default(uuid())
  userId            String
  walletAddress     String   // Creator's wallet
  title             String
  description       String?
  content           String   @db.Text // Full contract text
  templateType      String?  // "nda" | "service" | "sale" | "custom"
  status            String   @default("draft") // "draft" | "active" | "signed" | "cancelled"
  
  // Contract parties
  partyAName        String?
  partyAAddress     String?
  partyBName        String?
  partyBAddress     String?
  
  // Signatures
  signedByPartyA    Boolean  @default(false)
  signedByPartyB    Boolean  @default(false)
  signedAt          DateTime?
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([walletAddress])
  @@index([status])
}

model Message {
  id                String   @id @default(uuid())
  userId            String?
  walletAddress     String   // Sender's wallet (primary for Web3 users)
  username          String   // Display name
  content           String   @db.Text
  room              String   @default("general") // Chat room identifier
  createdAt         DateTime @default(now())
  
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([room])
  @@index([walletAddress])
  @@index([createdAt])
}
